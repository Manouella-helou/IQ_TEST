<!DOCTYPE html>
<html>
<head>
  <title>Professional IQ Assessment</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;      /* Keep blue for primary */
      --primary-dark: #3a56d4; /* Keep dark blue */
      --secondary: #4cc9f0;    /* Keep light blue */
      --warning: #f72585;      /* Keep warning color */
      --success: #06d6a0;      /* Keep success color */
      --dark: #212529;
      --light: #f8f9fa;
      --gray: #6c757d;
      --white: #ffffff;
      --red: #d00000;          /* New red color for notifications */
      --red-light: #ff5a5a;    /* Lighter red for highlights */
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    body { 
      font-family: 'Poppins', sans-serif;
      padding: 0;
      margin: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--dark);
      position: relative;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 900px;
      width: 100%;
      padding: 20px;
      margin: 40px auto;
      position: relative;
    }
    
    .logo {
      text-align: center;
      margin: 20px 0;
    }
    
    .logo h1 {
      font-weight: 700;
      color: var(--primary);  /* Keep blue logo */
      font-size: 2.5rem;
      margin: 0;
      letter-spacing: -1px;
    }
    
    .logo span {
      color: var(--secondary); /* Keep blue highlight */
    }
    
    #login, #question-card, #instructions, #loading, #completion { 
      transition: var(--transition);
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      background: var(--white);
      margin-bottom: 30px;
      width: 100%;
    }
    
    /* Overlay styles */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      color: var(--white);
      padding: 20px;
    }
    
    .overlay h2 {
      font-size: 28px;
      margin-bottom: 20px;
      color: var(--red); /* Change to red */
    }
    
    .overlay p {
      font-size: 18px;
      margin-bottom: 15px;
    }
    
    .overlay-btn {
      padding: 12px 24px;
      background: var(--white);
      color: var(--red); /* Change to red */
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      transition: var(--transition);
    }
    
    .overlay-btn:hover {
      background: var(--light);
      transform: translateY(-2px);
    }
    
    #question-card, #loading, #instructions, #completion { 
      display: none; 
    }
    
    .section-title {
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary); /* Keep blue titles */
      font-size: 1.5rem;
    }
    
    .question-info {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .question-info div {
      background: var(--light);
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--primary); /* Keep blue info */
      margin-bottom: 10px;
    }
    
    .question-text {
      font-size: 1.2rem;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    #question-img { 
      width: 100%; 
      max-height: 400px; 
      object-fit: contain; 
      border: 1px solid #eee; 
      margin-bottom: 20px; 
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .option { 
      margin: 15px 0; 
      padding: 15px;
      border: 2px solid #eee;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1.1rem;
      position: relative;
      overflow: hidden;
    }
    
    .option:hover {
      border-color: var(--secondary); /* Keep blue hover */
      background-color: rgba(76, 201, 240, 0.05);
      transform: translateX(5px);
    }
    
    .option::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 5px;
      background: var(--secondary); /* Keep blue indicator */
      opacity: 0;
      transition: var(--transition);
    }
    
    .option:hover::before {
      opacity: 1;
    }
    
    .option.selected {
      border-color: var(--primary); /* Keep blue selection */
      background-color: rgba(67, 97, 238, 0.05);
      transform: translateX(10px);
    }
    
    .option.selected::before {
      background: var(--primary); /* Keep blue indicator */
      opacity: 1;
    }
    
    .status { 
      color: var(--red); /* Change to red */
      margin: 10px 0; 
      font-weight: 600;
    }
    
    .btn { 
      padding: 12px 20px; 
      background: var(--primary); /* Keep blue buttons */
      color: var(--white); 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 16px;
      margin-top: 10px;
      font-weight: 500;
      transition: var(--transition);
      box-shadow: 0 4px 6px rgba(67, 97, 238, 0.15);
    }
    
    .btn:hover { 
      background: var(--primary-dark); /* Keep blue hover */
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(67, 97, 238, 0.2);
    }
    
    .btn-secondary {
      background: var(--gray);
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-success:hover {
      background: #05b484;
    }
    
    #timer {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 18px;
      background: linear-gradient(to right, var(--red), var(--red-light)); /* Change to red */
      color: var(--white);
      border-radius: 8px;
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 100;
      font-size: 1.1rem;
      display: none;
    }
    
    #camera-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      width: 180px;
      height: 135px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      display: none;
    }
    
    #video {
      width: 100%;
      height: 100%;
      background: #000;
    }
    
    .video-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.1);
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      pointer-events: none;
    }
    
    .recording-indicator {
      width: 10px;
      height: 10px;
      background: var(--red); /* Change to red */
      border-radius: 50%;
      margin: 5px;
      animation: blink 1.5s infinite;
    }
    
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    
    #canvas {
      display: none;
    }
    
    .notice {
      background: linear-gradient(to right, var(--primary), var(--secondary)); /* Keep blue gradient */
      color: var(--white);
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: var(--shadow);
    }
    
    .notice h3 {
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .notice ul {
      margin-left: 20px;
    }
    
    .notice li {
      margin-bottom: 10px;
    }
    
    input[type="email"], input[type="text"] {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #eee;
      border-radius: 8px;
      font-size: 16px;
      transition: var(--transition);
    }
    
    input[type="email"]:focus, input[type="text"]:focus {
      border-color: var(--primary); /* Keep blue focus */
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }
    
    .progress-container {
      margin: 20px 0;
      background-color: #eee;
      border-radius: 10px;
      height: 10px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 10px;
      background: linear-gradient(to right, var(--primary), var(--secondary)); /* Keep blue gradient */
      border-radius: 10px;
      transition: width 0.5s;
    }
    
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    
    .warning-text {
      color: var(--red); /* Change to red */
      font-weight: 600;
    }
    
    .camera-notice {
      background-color: rgba(208, 0, 0, 0.1); /* Change to red */
      border-left: 4px solid var(--red); /* Change to red */
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    
    .camera-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 20px auto;
      }
      
      .logo h1 {
        font-size: 2rem;
      }
      
      #login, #question-card, #instructions, #loading, #completion {
        padding: 20px;
      }
      
      .question-text {
        font-size: 1rem;
      }
      
      .option {
        padding: 12px;
        font-size: 1rem;
      }
      
      #camera-container {
        width: 120px;
        height: 90px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>IQ <span>Assessment</span></h1>
    </div>
    
    <div id="timer">
      <i class="fas fa-clock"></i> <span id="time-display">60:00</span>
    </div>
    
    <!-- Login Page -->
    <div id="login">
      <h2 class="section-title">Candidate Login</h2>
      <p>Please enter your information to begin the assessment:</p>
      
      <div class="camera-notice">
        <p><i class="fas fa-camera"></i> <strong>This assessment uses camera proctoring.</strong> You'll be asked to grant camera access when you start the test.</p>
        <p>Camera access helps maintain assessment integrity and prevent cheating.</p>
      </div>
      
      <input type="email" id="email" placeholder="Enter your email">
      <input type="text" id="name" placeholder="Enter your full name">
      <button class="btn" onclick="showInstructions()">Continue</button>
      <div id="login-error" class="status"></div>
    </div>
    
    <!-- Instructions Page -->
    <div id="instructions">
      <h2 class="section-title">Assessment Instructions</h2>
      <div class="notice">
        <h3><i class="fas fa-exclamation-triangle"></i> Important Proctoring Rules</h3>
        <p>This assessment has strict proctoring requirements. Violation of any rule may result in immediate test termination.</p>
        <ul>
          <li><strong>Camera monitoring is mandatory</strong> throughout the assessment. Your face must remain visible.</li>
          <li>The assessment must be completed within <strong>60 minutes</strong>.</li>
          <li><strong>Do not leave this browser tab</strong> or switch to another application.</li>
          <li><strong>Do not move your cursor outside the window</strong> or use keyboard shortcuts.</li>
          <li>All unusual activities will be recorded and flagged for review.</li>
        </ul>
      </div>
      <p>The assessment consists of timed questions designed to evaluate various cognitive abilities. Your responses will be analyzed to generate your IQ score.</p>
      <p>Once you click "Start Assessment", your session will begin immediately.</p>
      <button class="btn" onclick="startTest()">Start Assessment</button>
    </div>

    <!-- Loading Screen -->
    <div id="loading">
      <h2 class="section-title">Preparing Your Assessment</h2>
      <p>Please wait while we load your personalized questions...</p>
      <div class="progress-container">
        <div class="progress-bar" id="loading-progress" style="width: 0%"></div>
      </div>
      <p id="loading-status">Initializing...</p>
    </div>
    
    <!-- Status Display -->
    <div id="status" class="status"></div>

    <!-- Question Card -->
    <div id="question-card">
      <div class="question-info">
        <div id="qNumber"><i class="fas fa-list-ol"></i> Question 1 of 9</div>
        <div id="qCategory"><i class="fas fa-tag"></i> Category</div>
        <div id="qSection"><i class="fas fa-layer-group"></i> Section</div>
      </div>
      
      <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      
      <div id="qText" class="question-text"></div>
      <img id="question-img" src="" alt="Question Image" onerror="handleImageError(this)">
      <div id="image-status" class="status"></div>
      <div id="options"></div>
      
      <div class="nav-buttons">
        <button class="btn btn-secondary" id="prev-btn" onclick="prevQuestion()"><i class="fas fa-arrow-left"></i> Previous</button>
        <button class="btn" id="next-btn" onclick="nextQuestion()">Next <i class="fas fa-arrow-right"></i></button>
        <button class="btn btn-success" id="submit-btn" onclick="submitTest()" style="display:none;"><i class="fas fa-check-circle"></i> Submit</button>
      </div>
    </div>
    
    <!-- Completion Page -->
    <div id="completion">
      <h2 class="section-title">Assessment Complete</h2>
      <div style="text-align: center; margin: 30px 0;">
        <i class="fas fa-check-circle" style="font-size: 60px; color: var(--success);"></i>
      </div>
      <p>Thank you for completing the IQ assessment.</p>
      <p>Your results have been submitted successfully and will be processed.</p>
      <p>You may close this window now.</p>
    </div>
    
    <!-- Camera Container -->
    <div id="camera-container">
      <video id="video" autoplay muted></video>
      <canvas id="canvas" width="640" height="480"></canvas>
      <div class="video-overlay">
        <div class="recording-indicator"></div>
      </div>
    </div>
    
    <!-- Camera Permission Alert -->
    <div id="camera-permission-overlay" class="overlay">
      <h2><i class="fas fa-camera"></i> Camera Access Required</h2>
      <p>This assessment requires camera access for proctoring purposes.</p>
      <p>Please click "Allow" when prompted by your browser.</p>
      <div id="camera-status-message"></div>
      <div class="camera-buttons">
        <button id="retry-camera-btn" class="overlay-btn">Retry Camera Access</button>
        <button id="proceed-without-camera-btn" class="overlay-btn" style="background-color: var(--red); color: white;">Proceed Without Camera</button>
      </div>
    </div>
    
    <!-- Tab Switch Alert -->
    <div id="tab-switch-overlay" class="overlay">
      <h2><i class="fas fa-exclamation-triangle"></i> Tab Switch Detected</h2>
      <p>We detected that you switched to another tab or window.</p>
      <p>This activity has been recorded and may affect your assessment.</p>
      <p id="tab-switch-count">Total tab switches: 0</p>
      <button id="continue-btn" class="overlay-btn">Continue Assessment</button>
    </div>
    
    <!-- Cursor Leave Alert -->
    <div id="cursor-leave-overlay" class="overlay">
      <h2><i class="fas fa-exclamation-triangle"></i> Cursor Left Window</h2>
      <p>Your cursor moved outside the assessment window.</p>
      <p>This activity has been recorded and may affect your assessment.</p>
      <p id="cursor-leave-count">Total violations: 0</p>
      <button id="cursor-continue-btn" class="overlay-btn">Continue Assessment</button>
    </div>

  <script>
    // Global variables
    let email = "";
    let name = "";
    let questions = [];
    let current = 0;
    let answers = {};
    let startTime;
    let timerInterval;
    let remainingTime = 60 * 60; // 60 minutes in seconds
    let tabSwitchCount = 0;
    let cursorLeaveCount = 0;
    let webcamActive = false;
    let sessionId = null;
    let loadingInterval = null;
    let loadingProgress = 0;
    let mouseIsInside = true;
    const SNAPSHOT_INTERVAL = 5 * 1000; // 5 seconds in milliseconds
    const API_URL = 'http://localhost:5001'; // Change this to your API endpoint
    
    // Start directly with the login screen
    document.addEventListener('DOMContentLoaded', function() {
      // Login screen is shown by default
      
      // Setup camera permission button handlers
      document.getElementById('retry-camera-btn').addEventListener('click', function() {
        document.getElementById('camera-status-message').textContent = 'Requesting camera access again...';
        requestCameraAccess();
      });
    });
    
    
    // Handle image loading errors
    function handleImageError(imgElement) {
      const imgSrc = imgElement.src;
      document.getElementById('image-status').innerText = `Error loading image: ${imgSrc}`;
      console.error('Image failed to load:', imgSrc);
      
      // Hide the broken image
      imgElement.style.display = 'none';
    }
    
    // Show instructions after email entry
    function showInstructions() {
      email = document.getElementById("email").value;
      name = document.getElementById("name").value;
      
      if (!email || !email.includes('@')) {
        document.getElementById("login-error").innerText = "Please enter a valid email address";
        return;
      }
      
      if (!name) {
        document.getElementById("login-error").innerText = "Please enter your name";
        return;
      }
      
      document.getElementById("login").style.display = "none";
      document.getElementById("instructions").style.display = "block";
    }

    // Simulate loading progress
    function simulateLoading() {
      loadingProgress = 0;
      const progressBar = document.getElementById('loading-progress');
      const loadingStatus = document.getElementById('loading-status');
      
      loadingInterval = setInterval(() => {
        loadingProgress += Math.random() * 15;
        if (loadingProgress >= 100) {
          loadingProgress = 100;
          clearInterval(loadingInterval);
        }
        
        progressBar.style.width = `${loadingProgress}%`;
        
        if (loadingProgress < 30) {
          loadingStatus.textContent = "Connecting to assessment server...";
        } else if (loadingProgress < 60) {
          loadingStatus.textContent = "Preparing personalized question set...";
        } else if (loadingProgress < 90) {
          loadingStatus.textContent = "Initializing test environment...";
        } else {
          loadingStatus.textContent = "Almost ready...";
        }
      }, 500);
    }
    
    // Request camera access with retry and fallback options
    async function requestCameraAccess() {
      const overlay = document.getElementById('camera-permission-overlay');
      const statusMessage = document.getElementById('camera-status-message');
      const proceedButton = document.getElementById('proceed-without-camera-btn');
      
      overlay.style.display = 'flex';
      statusMessage.textContent = 'Requesting camera access...';
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        statusMessage.textContent = 'Camera access granted! Proceeding with test...';
        
        // Store the stream and set up the video element
        window.cameraStream = stream;
        const video = document.getElementById('video');
        video.srcObject = stream;
        webcamActive = true;
        
        // Hide overlay after a short delay
        setTimeout(() => {
          overlay.style.display = 'none';
          continueLoadingTest();
        }, 1500);
        
        return true;
      } catch (error) {
        console.error('Camera access error:', error);
        
        statusMessage.innerHTML = `<span style="color: var(--red);">Camera access denied or unavailable.</span><br>
                                  <strong>You cannot proceed with the assessment without allowing camera access.</strong><br>
                                  Please click "Retry Camera Access" and allow camera permissions in your browser.`;
        
        // Hide the "proceed without camera" button
        proceedButton.style.display = 'none';
        
        return false;
      }
    }
    
    // Continue loading the test after camera decision
    function continueLoadingTest() {
      // Start monitoring if camera is active
      if (webcamActive) {
        document.getElementById('camera-container').style.display = 'block';
      }
      
      // Continue with the rest of test setup
      detectTabSwitches();
      detectCursorMovement();
      
      // Ensure loading animation has run for at least 2 seconds
      setTimeout(() => {
        clearInterval(loadingInterval);
        document.getElementById("loading-progress").style.width = "100%";
        document.getElementById("loading-status").textContent = "Complete!";
        
        setTimeout(() => {
          document.getElementById("loading").style.display = "none";
          document.getElementById("question-card").style.display = "block";
          document.getElementById("timer").style.display = "block";
          
          showQuestion();
        }, 500);
      }, 2000);
    }

    async function startTest() {
      document.getElementById("instructions").style.display = "none";
      document.getElementById("loading").style.display = "block";
      document.getElementById("status").innerText = "";

      simulateLoading();

      try {
        // Step 1: Check API reachable
        await checkApiReachable();

        // Step 2: Create session
        await createSession();

        // Step 3: Start timer
        startTimer();

        // Step 4: Load questions
        console.log('Loading questions...');
        await loadQuestions();

        // Step 5: Request camera access
        await setupCamera();

        // Step 6: Finalize loading and show questions
        finalizeTestLoading();

        // Step 7: Enable proctoring detectors
        detectTabSwitches();
        detectCursorMovement();

      } catch (error) {
        console.error("Error starting test:", error);

        // Handle failure
        document.getElementById("status").innerText = "Error starting test: " + error.message;
        document.getElementById("instructions").style.display = "block";
        document.getElementById("loading").style.display = "none";
        clearInterval(loadingInterval);
      }
    }

    // Check if API is reachable
    async function checkApiReachable() {
      console.log('Checking API availability...');
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);

      try {
        const response = await fetch(`${API_URL}/ping`, { signal: controller.signal });
        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`API check failed with status: ${response.status}`);
        }
        console.log('API is reachable');
      } catch (error) {
        clearTimeout(timeoutId);
        throw new Error("Cannot connect to assessment server. Please check your internet connection and try again.");
      }
    }

    // Create a session with retry
    async function createSession() {
      console.log('Creating session...');
      let retries = 0;
      const maxRetries = 3;

      while (retries < maxRetries) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        try {
          const response = await fetch(`${API_URL}/create_session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: email,
              name: name,
              ip_address: 'client-side',
              browser_info: navigator.userAgent
            }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
          }

          const data = await response.json();
          if (!data.session_id) {
            throw new Error("Invalid session data");
          }

          sessionId = data.session_id;
          console.log('Session created:', sessionId);
          return;
        } catch (err) {
          clearTimeout(timeoutId);
          retries++;
          console.log(`Session creation attempt ${retries} failed: ${err.message}`);

          if (retries >= maxRetries) {
            throw new Error("Failed to create session after multiple attempts. Please try again later.");
          }

          await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s before retry
        }
      }
    }

    // Setup Camera (Must Succeed or throw error)
    async function setupCamera() {
      console.log('Requesting camera access...');
      
      const cameraTimeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Camera permission timed out')), 10000);
      });

      const cameraAccessPromise = navigator.mediaDevices.getUserMedia({ video: true });

      try {
        const stream = await Promise.race([cameraAccessPromise, cameraTimeoutPromise]);

        console.log('Camera access granted');
        const video = document.getElementById('video');
        video.srcObject = stream;
        webcamActive = true;

        reportProctorEvent('camera_enabled', {});
        return true;

      } catch (error) {
        console.log('Camera access failed:', error.message);
        reportProctorEvent('camera_disabled', { reason: error.message });
        
        // Show camera permission overlay and force the user to retry
        const overlay = document.getElementById('camera-permission-overlay');
        const statusMessage = document.getElementById('camera-status-message');
        const retryButton = document.getElementById('retry-camera-btn');
        const proceedButton = document.getElementById('proceed-without-camera-btn');
        
        statusMessage.innerHTML = `<span style="color: var(--red);">Camera access denied or unavailable.</span><br>
                                  <strong>You cannot proceed with the assessment without allowing camera access.</strong><br>
                                  Please click "Retry Camera Access" and allow camera permissions in your browser.`;
        
        // Hide the "proceed without camera" button
        proceedButton.style.display = 'none';
        
        // Show the overlay
        overlay.style.display = 'flex';
        
        // We'll throw an error to halt the test startup flow
        throw new Error("Camera access is required to proceed. Please allow camera access.");
      }
    }

    // Finalize test loading
    function finalizeTestLoading() {
      setTimeout(() => {
        clearInterval(loadingInterval);
        document.getElementById("loading-progress").style.width = "100%";
        document.getElementById("loading-status").textContent = "Complete!";

        setTimeout(() => {
          document.getElementById("loading").style.display = "none";
          document.getElementById("question-card").style.display = "block";
          document.getElementById("timer").style.display = "block";

          if (webcamActive) {
            document.getElementById("camera-container").style.display = "block";
          }

          showQuestion();
        }, 500);
      }, 1500);
    }

    // Load questions from the server
    async function loadQuestions() {
      try {
        // Create an AbortController for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
        
        const response = await fetch(`${API_URL}/get_questions`, {
          signal: controller.signal
        }).catch(error => {
          if (error.name === 'AbortError') {
            throw new Error('Request timed out. Please check your connection and try again.');
          }
          throw error;
        });
        
        // Clear the timeout since the fetch succeeded
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.questions || data.questions.length === 0) {
          throw new Error("No questions available. Please try again later.");
        }
        
        questions = data.questions;
        
        // Group questions by section
        const sectionMap = {};
        questions.forEach(q => {
          // Extract the section number from section_name (e.g., "Section 1" -> 1)
          const sectionMatch = q.section_name.match(/\d+/);
          const sectionNumber = sectionMatch ? parseInt(sectionMatch[0]) : 0;
          
          const sectionKey = `Section ${sectionNumber}`;
          if (!sectionMap[sectionKey]) {
            sectionMap[sectionKey] = [];
          }
          sectionMap[sectionKey].push(q);
        });
        
        // Choose a fixed number from each section
        const questionsPerSection = 3; // 3 questions from each section
        const selectedQuestions = [];
        
        for (const section in sectionMap) {
          const sectionQuestions = sectionMap[section];
          // If there are questions for this section
          if (sectionQuestions && sectionQuestions.length > 0) {
            // Shuffle the questions
            const shuffled = sectionQuestions.sort(() => 0.5 - Math.random());
            // Select the number we want (or all if there are fewer than requested)
            const selected = shuffled.slice(0, Math.min(questionsPerSection, shuffled.length));
            selectedQuestions.push(...selected);
          }
        }
        
        if (selectedQuestions.length === 0) {
          throw new Error("No questions available for your assessment. Please contact support.");
        }
        
        questions = selectedQuestions; // Replace with our selected questions
        
        console.log(`Loaded ${questions.length} selected questions`);
        return questions;
      } catch (error) {
        console.error("Error loading questions:", error);
        throw new Error(`Failed to load questions: ${error.message}`);
      }
    }
    
    // Initialize webcam
    async function initWebcam() {
      try {
        // If we already got camera access during the check, use that stream
        if (window.cameraStream) {
          const video = document.getElementById('video');
          video.srcObject = window.cameraStream;
          webcamActive = true;
          return true;
        }
        
        // Otherwise try to get access again
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.getElementById('video');
        video.srcObject = stream;
        webcamActive = true;
        return true;
      } catch (error) {
        console.error("Webcam initialization error:", error);
        return false;
      }
    }
    
    // Detect tab switching
    function detectTabSwitches() {
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          tabSwitchCount++;
          console.log(`Tab switch detected: ${tabSwitchCount} times`);
          
          // Report proctoring event
          reportProctorEvent('tab_switch', { count: tabSwitchCount });
          
          // Show tab switch alert when they return
          document.addEventListener('visibilitychange', function onReturn() {
            if (document.visibilityState === 'visible') {
              document.removeEventListener('visibilitychange', onReturn);
              showTabSwitchAlert();
            }
          });
        }
      });
    }
    
    // Show tab switch alert
    function showTabSwitchAlert() {
      const overlay = document.getElementById('tab-switch-overlay');
      document.getElementById('tab-switch-count').innerText = `Total tab switches: ${tabSwitchCount}`;
      overlay.style.display = 'flex';
      
      // Add event listener to continue button
      document.getElementById('continue-btn').addEventListener('click', () => {
        overlay.style.display = 'none';
      });
    }
    
    // Detect cursor movement outside window
    function detectCursorMovement() {
      // Set initial state
      mouseIsInside = true;
      
      // When mouse leaves the window
      document.documentElement.addEventListener('mouseout', (e) => {
        // Check if the mouse actually left the window (not just moved to another element)
        if (e.relatedTarget === null || e.relatedTarget.nodeName === 'HTML') {
          mouseIsInside = false;
          cursorLeaveCount++;
          console.log(`Cursor left window: ${cursorLeaveCount} times`);
          
          // Report proctoring event
          reportProctorEvent('cursor_leave', { count: cursorLeaveCount });
          
          // Show cursor leave alert on serious violations (more than 1)
          if (cursorLeaveCount > 1) {
            showCursorLeaveAlert();
          }
        }
      });
      
      // When mouse enters the window
      document.documentElement.addEventListener('mouseover', () => {
        mouseIsInside = true;
      });
      
      // Monitor mouse movement to ensure it stays inside
      document.addEventListener('mousemove', (e) => {
        // If mouse is near the edge (within 5px), consider it a potential violation
        const buffer = 5;
        if (
          e.clientX <= buffer || 
          e.clientX >= window.innerWidth - buffer ||
          e.clientY <= buffer || 
          e.clientY >= window.innerHeight - buffer
        ) {
          console.log('Mouse near window edge', { x: e.clientX, y: e.clientY });
        }
      });
    }
    
    // Show cursor leave alert
    function showCursorLeaveAlert() {
      const overlay = document.getElementById('cursor-leave-overlay');
      document.getElementById('cursor-leave-count').innerText = `Total violations: ${cursorLeaveCount}`;
      overlay.style.display = 'flex';
      
      // Add event listener to continue button
      document.getElementById('cursor-continue-btn').addEventListener('click', () => {
        overlay.style.display = 'none';
      });
    }
    
    // Start the timer countdown
    function startTimer() {
      startTime = new Date();
      
      timerInterval = setInterval(() => {
        const now = new Date();
        const timeElapsed = Math.floor((now - startTime) / 1000);
        remainingTime = Math.max(0, 60 * 60 - timeElapsed);
        
        // Update timer display
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;
        document.getElementById('time-display').innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Warning colors when time is running low
        if (remainingTime <= 300) { // last 5 minutes
          document.getElementById('timer').style.background = 'linear-gradient(to right, var(--red), var(--red-light))';
        }
        
        // Auto-submit when time runs out
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          submitTest();
        }
      }, 1000);
    }

    // Display the current question
    function showQuestion() {
      if (questions.length === 0) {
        document.getElementById("status").innerText = "No questions available";
        console.error('No questions available to display');
        return;
      }
      
      if (current >= questions.length) {
        submitTest();
        return;
      }

      const q = questions[current];
      console.log('Showing question', { current, questionId: q.question_id, type: q.question_type });
      
      document.getElementById("qNumber").innerHTML = `<i class="fas fa-list-ol"></i> Question ${current + 1} of ${questions.length}`;
      document.getElementById("qCategory").innerHTML = `<i class="fas fa-tag"></i> ${q.category_name}`;
      document.getElementById("qSection").innerHTML = `<i class="fas fa-layer-group"></i> ${q.section_name}`;
      
      // Update progress bar
      const progressBar = document.getElementById("progress-bar");
      progressBar.style.width = `${((current + 1) / questions.length) * 100}%`;
      
      // Set question text
      document.getElementById("qText").innerText = q.question_text || "";
      
      // Set image source if available
      const img = document.getElementById("question-img");
      document.getElementById('image-status').innerText = '';
      
      if (q.image_path) {
        const imgUrl = `${API_URL}/images/${q.image_path}`;
        console.log('Loading image', { path: q.image_path, url: imgUrl });
        img.src = imgUrl;
        img.style.display = "block";
      } else {
        console.log('No image for this question');
        img.style.display = "none";
      }

      // Display options
      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = '';
      
      // Create option elements
      if (q.options && q.options.length > 0) {
        q.options.forEach((option, index) => {
          const div = document.createElement('div');
          div.className = 'option';
          div.dataset.optionId = option.option_id;
          div.innerHTML = option.option_text;
          
          // If this option was previously selected, mark it
          if (answers[q.question_id] === option.option_id) {
            div.classList.add('selected');
          }
          
          div.addEventListener('click', () => {
            // Remove selected class from all options
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            div.classList.add('selected');
            
            // Store the answer
            answers[q.question_id] = option.option_id;
          });
          
          optionsDiv.appendChild(div);
        });
      } else {
        console.error('No options found for this question', { questionId: q.question_id });
        optionsDiv.innerHTML = '<div class="alert alert-danger">No options available for this question</div>';
      }

      // Show/hide navigation buttons
      document.getElementById("prev-btn").style.display = current > 0 ? "inline-block" : "none";
      
      if (current === questions.length - 1) {
        document.getElementById("next-btn").style.display = "none";
        document.getElementById("submit-btn").style.display = "inline-block";
      } else {
        document.getElementById("next-btn").style.display = "inline-block";
        document.getElementById("submit-btn").style.display = "none";
      }
    }

    // Move to the previous question
    function prevQuestion() {
      if (current > 0) {
        saveCurrentAnswer();
        current--;
        showQuestion();
      }
    }

    // Move to the next question
    function nextQuestion() {
      saveCurrentAnswer();
      current++;
      showQuestion();
    }
    
    // Save the current answer
    function saveCurrentAnswer() {
      const q = questions[current];
      const selectedOption = document.querySelector('.option.selected');
      
      if (selectedOption && q) {
        const optionId = parseInt(selectedOption.dataset.optionId);
        answers[q.question_id] = optionId;
        
        // Send answer to server
        saveAnswer(q.question_id, optionId);
      }
    }
    
    // Save answer to server
    async function saveAnswer(questionId, optionId) {
      try {
        console.log('Saving answer', { questionId, optionId });
        
        const response = await fetch(`${API_URL}/save_answer`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: sessionId,
            question_id: questionId,
            option_id: optionId,
            time_spent: 0 // Time tracking not implemented in this version
          })
        });
        
        const data = await response.json();
        console.log('Answer saved', data);
      } catch (error) {
        console.error("Error saving answer:", error);
      }
    }

    // Submit the test
    async function submitTest() {
      // Ensure the last answer is recorded
      saveCurrentAnswer();

      // Stop all monitoring
      clearInterval(timerInterval);
      
      try {
        console.log('Completing test session...');
        
        // Complete the session
        const response = await fetch(`${API_URL}/complete_session`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: sessionId
          })
        });
        
        const data = await response.json();
        console.log('Test session completed', data);
        
        // Show completion screen
        document.getElementById("question-card").style.display = "none";
        document.getElementById("timer").style.display = "none";
        document.getElementById("camera-container").style.display = "none";
        document.getElementById("completion").style.display = "block";
        
      } catch (error) {
        console.error("Error submitting test:", error);
        document.getElementById("status").innerText = "Error submitting test: " + error.message;
      }
    }
    
    // Report proctoring events to server
    async function reportProctorEvent(eventType, eventData) {
      if (!sessionId) return;
      
      try {
        console.log('Reporting proctor event', { type: eventType, data: eventData });
        
        await fetch(`${API_URL}/proctor_event`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: sessionId,
            event_type: eventType,
            event_data: JSON.stringify(eventData)
          })
        });
      } catch (error) {
        console.error("Error reporting proctoring event:", error);
      }
    }
    
    // Prevent copying and pasting
    document.addEventListener('copy', function(e) {
      e.preventDefault();
      reportProctorEvent('copy_attempt', {});
    });
    
    document.addEventListener('paste', function(e) {
      e.preventDefault();
      reportProctorEvent('paste_attempt', {});
    });
    
    // Prevent right-click
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      reportProctorEvent('right_click_attempt', {});
      return false;
    });
    
    // Prevent keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Detect Ctrl, Alt combinations
      if (e.ctrlKey || e.altKey || e.metaKey) {
        e.preventDefault();
        reportProctorEvent('keyboard_shortcut_attempt', { key: e.key });
        return false;
      }
      
      // Allow only arrow keys, tab, and numbers for navigation
      const allowedKeys = ['ArrowLeft', 'ArrowRight', 'Tab', 'Enter', 'Backspace'];
      if (!allowedKeys.includes(e.key) && !/^[0-9]$/.test(e.key)) {
        // Allow typing in text input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          return true;
        }
        
        e.preventDefault();
        reportProctorEvent('disallowed_key_attempt', { key: e.key });
        return false;
      }
    });
    
    // Warn before closing/refreshing page
    window.addEventListener('beforeunload', function(e) {
      if (document.getElementById("question-card").style.display === "block") {
        const message = 'Are you sure you want to leave? Your progress will be lost and this will be recorded.';
        e.returnValue = message;
        reportProctorEvent('page_close_attempt', {});
        return message;
      }
    });
  </script>
</body>
</html>